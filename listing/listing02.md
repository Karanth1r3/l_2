Что выведет программа? Объяснить вывод программы. Объяснить как работают defer’ы и их порядок вызовов.

package main

import (
  "fmt"
)


func test() (x int) {
  defer func() {
    x++
  }()
  x = 1
  return
}


func anotherTest() int {
  var x int
  defer func() {
    x++
  }()
  x = 1
  return x
}


func main() {
  fmt.Println(test())
  fmt.Println(anotherTest())
}
Ответ:

...
defer'ы кладутся в стек, поэтому первый объявленный defer будет вызван в функции последним, последний - первым. defer откладывает вызов кода до return'а его функции.
Переменные хранят значения на момент объявления defer =>

Поэтому в функции test порядок такой:
x = 1
x++ // 2

В anotherTest:
var x int (0)
x = 1
x++ 2
return x // x = 2, 
но в функции another test меняется локальная переменная, адрес области стека с возвращаемым значением не равен адресу области стека внутренней x;
в test компилятор свяжет x в defer с возвращаемым x => результат записывается в область стека с возвращаемым значением

Вывод: 
2
1